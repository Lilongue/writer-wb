# Концепция приложения "Помощник писателя" (Гибридная модель)

Этот документ описывает архитектурный подход, основанный на гибридной модели хранения данных. Цель — объединить надежность и скорость базы данных для структурированной информации с гибкостью и удобством редактирования текстовых файлов для контента.

Этот подход напрямую решает три ключевые проблемы существующих аналогов:
1.  **Гибкость структуры:** Пользователь сам определяет типы объектов и их свойства.
2.  **Локальное хранение:** Все данные хранятся локально в папке проекта, обеспечивая полный контроль и приватность.
3.  **Свобода выбора редактора:** Текстовый контент (повествование, описания) хранится в стандартных `.md` файлах, которые можно редактировать в любом привычном редакторе (VS Code, Obsidian, Typora и т.д.).

## Структура Проекта

Каждый проект — это одна папка на компьютере пользователя. Внутри этой папки приложение создает и управляет следующей структурой:

```
/Моя Книга/
├── project.sqlite      <-- Локальная база данных. Сердце проекта.
├── /narrative/         <-- Каталог для файлов повествования.
│   ├── /part-1/
│   │   └── chapter-1.md
│   └── ...
└── /world/             <-- Каталог для файлов с описанием мира.
    ├── /characters/
    │   ├── aragorn.md
    │   └── ...
    ├── /locations/
    │   └── gondor.md
    └── ...
```

*   `project.sqlite`: Единственный файл базы данных SQLite. Он хранит всю структуру, метаданные, связи, теги, таймлайны — всё, кроме самого текста. Это "мозг" проекта.
*   `/narrative/`, `/world/`: Папки, содержащие контент в виде текстовых файлов формата `Markdown`. Структура этих папок управляется приложением, но их содержимое — обычные текстовые файлы.

## Описание Сущностей

### 1. Повествование и Описание Мира

Эти сущности теперь работают по единому принципу.

*   **В базе данных (`project.sqlite`):**
    *   Хранится иерархия и порядок элементов (например, порядок глав в части).
    *   Для каждого элемента (сцены, персонажа, локации) создается запись с уникальным `ID`.
    *   В этой записи хранятся все **структурированные данные**: название, пользовательские характеристики (например, `Дата рождения` у персонажа), а также **путь к файлу с контентом** (например, `world/characters/aragorn.md`).

*   **На файловой системе:**
    *   Для каждого элемента создается `.md` файл, содержащий его **неструктурированное описание** — основной текст. Пользователь может свободно редактировать этот файл.

### 2. Связи, Таймлайны и Теги

Эти сущности хранятся **исключительно в базе данных `project.sqlite`**.

*   **Связи:** Представляют из себя таблицу в БД, где каждая строка — это `(ID связи, ID исходного объекта, ID целевого объекта, описание связи)`. Это обеспечивает целостность данных: при удалении объекта можно легко найти и удалить все связанные с ним упоминания. Визуализация графа будет строиться на основе этой таблицы.
*   **Таймлайны:** Это набор таблиц в БД, описывающих временные шкалы и события на них. Событие может быть привязано к любому объекту по его `ID`. Реализация интерфейса может использовать готовую библиотеку для отрисовки диаграмм.
*   **Теги:** Классические таблицы `tags` и `entity_tags` для реализации связи "многие-ко-многим".

## Ключевой механизм: Работа со сторонними редакторами

Это ядро, позволяющее совместить БД и файлы.

1.  **Создание объекта:** Когда пользователь в интерфейсе приложения создает, например, нового персонажа, приложение:
    а. Создает новую запись в таблице `characters` в `project.sqlite`.
    б. Создает соответствующий файл на диске, например, `/world/characters/new-character.md`, возможно, с каким-то базовым шаблоном.

2.  **Редактирование:** Пользователь открывает этот `.md` файл в своем любимом редакторе и пишет текст.

3.  **Синхронизация:** Приложение "наблюдает" за файловой системой в папке проекта. Как только файл сохраняется, приложение получает уведомление. Поскольку в БД хранится путь к этому файлу, приложение знает, к какому объекту он относится, и может обновить свое внутреннее состояние (например, для поиска по тексту).

**Важное разделение:**
*   **Структурные изменения** (создание/удаление объектов, изменение порядка глав, добавление тегов, правка характеристик) производятся **в интерфейсе приложения**.
*   **Редактирование контента** (написание текста главы, описания персонажа) производится **в любом текстовом редакторе**.

## Преимущества этой модели

*   **Надежность:** Целостность данных и связей гарантируется базой данных.
*   **Производительность:** Все сложные запросы (поиск, фильтрация, построение графа) выполняются быстро внутри БД.
*   **Гибкость и удобство:** Писатель использует привычные и мощные инструменты для написания текста.
*   **Прозрачность и контроль:** Пользователь видит понятную структуру файлов и может быть уверен, что его текст не заперт в проприетарном формате.
