# ADR-001: Схема базы данных и обработка пользовательских полей

**Статус:** Принято (Пересмотрено)

## Контекст

Приложению требуется гибкая схема данных, позволяющая хранить иерархию повествования, объекты мира и связи между любыми из этих сущностей. Ключевое требование — предоставить пользователям (писателям) возможность создавать собственные типы объектов с произвольными полями (например, поле "Возраст" для "Персонажа").

В ходе обсуждения была выявлена фундаментальная разница в природе сущностей:
- **Объекты мира** (персонажи, локации) используются как "опора для созидания". Их атрибуты (пользовательские поля) определяются *до* написания текста и служат основой для него.
- **Элементы повествования** (главы, сцены) описываются *постфактум*. Дополнительная информация о них (теги, пометки) является не определяющей, а аналитической.

## Принятое решение

Принята архитектура, разделяющая сущности на две категории для точного отражения их доменной модели. Целостность связей обеспечивается через техническую "прокси-таблицу" (`all_entities`).

1.  **Разделение таблиц:** Сущности разделены на `narrative_items` (для повествования) и `world_objects` (для объектов мира).

2.  **Жесткая структура для повествования:** Таблица `narrative_items` имеет фиксированный набор полей (`parent_id`, `sort_order`, `file_path`) и не поддерживает кастомные поля. Это отражает их структурную роль.

3.  **Гибкая структура для объектов мира:** Таблица `world_objects` содержит поле `properties` (JSON) для хранения пользовательских полей, что обеспечивает необходимую гибкость.

4.  **Прокси-таблица `all_entities`:** Для обеспечения универсальных связей введена таблица `all_entities`. Она содержит глобальный ID и по одному nullable внешнему ключу на каждую из конкретных таблиц сущностей. Это позволяет таблице `connections` ссылаться на глобальный ID, сохраняя целостность `FOREIGN KEY` на уровне БД.

5.  **Шаблоны в `entity_templates`:** Таблица шаблонов содержит дополнительное поле `category`, указывающее, к какой из двух категорий (`narrative` или `world`) относится шаблон.

## Последствия

### Положительные

-   **Точное отражение доменной модели:** Схема четко разделяет структурные элементы повествования и гибкие объекты мира.
-   **Сохранение целостности данных:** `FOREIGN KEY` в таблице `connections` работает, предотвращая "висячие" связи.
-   **Сочетание структуры и гибкости:** Система одновременно обеспечивает жесткую структуру для повествования и полную гибкость для создания объектов мира.

### Отрицательные

-   **Усложнение запросов:** Любые запросы, затрагивающие связи, требуют дополнительных `JOIN`-ов через прокси-таблицу `all_entities`.
-   **Усложнение операций записи:** Создание новой сущности требует двух `INSERT`-ов: в конкретную таблицу и в прокси-таблицу.

## Рассмотренные альтернативы

### Единая таблица `entities`

Изначально принятый подход, который был пересмотрен.

-   **Описание:** Все сущности хранятся в одной таблице. Гибкость достигается за счет `NULL`-колонок и `properties` (JSON).
-   **Преимущества:** Максимальная простота запросов для связей и иерархии.
-   **Причина отказа:** Подход не отражает фундаментальную семантическую разницу между "опорой для созидания" (объекты мира) и "аналитическими метками" (повествование). Он смешивает принципиально разные по своей природе сущности в "общую кучу", усложняя логику на уровне приложения, которое вынуждено разбирать тип объекта, чтобы понять его поведение.