# Архитектура приложения

Этот документ описывает ключевые архитектурные решения и соглашения, принятые в проекте. Его цель — поддерживать консистентность кода при дальнейшей разработке.

---

## Структура Main-процесса (`src/main`)

Логика основного процесса разделена на несколько слоев для лучшей организации.

### 1. Файлы в корне `src/main`

* `main.ts`: **Точка входа.** Отвечает за создание окна (`BrowserWindow`), управление жизненным циклом приложения и регистрацию обработчиков `ipcMain`.
* `menu.ts`: Отвечает за создание и управление нативным меню приложения.
* `preload.ts`: **Мост безопасности.** Скрипт, который выполняется в контексте `renderer`-процесса, но имеет доступ к API `Node.js`. Используется для безопасного предоставления `ipcRenderer` в React-приложение.
* `util.ts`: Общие утилитарные функции, не привязанные к конкретной бизнес-логике.

### 2. Сервисный слой (`src/main/services`)

Содержит классы, инкапсулирующие бизнес-логику приложения.

* `ProjectService.ts`: **Менеджер проектов.**
  * **Ответственность:** Управление жизненным циклом проекта: создание, открытие, закрытие. Работа с файлами проекта на верхнем уровне (например, `project.sqlite`).
  * **Не должен:** Содержать логику, специфичную для доменных областей (повествование, мир и т.д.).

* `NarrativeService.ts`: **Менеджер повествования.**
  * **Ответственность:** Бизнес-логика, связанная с элементами повествования (части, главы, сцены). Реализует полный CRUD (создание, переименование, удаление, изменение порядка) для этих элементов.
  * **Взаимодействие:** Использует `DAO` для получения и сохранения данных в БД. После изменения данных отправляет событие `narrative-changed` в `eventBus`.

* `WorldObjectService.ts`: **Менеджер объектов мира.**
  * **Ответственность:** Бизнес-логика, связанная с объектами мира (персонажи, локации). Реализует полный CRUD (создание, переименование, удаление) для этих объектов, а также управляет их кастомными полями.
  * **Взаимодействие:** Использует `DAO` для получения и сохранения данных в БД. После изменения данных отправляет событие `world-objects-changed` в `eventBus`.

* `FileSystemService.ts`: **Менеджер файловой системы.**
  * **Ответственность:** Абстракция над модулем `fs`. Предоставляет методы для работы с файлами и папками, которые могут понадобиться другим сервисам.

### 3. Слой доступа к данным (`src/main/data`)

Содержит классы, ответственные за прямое взаимодействие с базой данных.

* `GenericDao.ts`: **Data Access Object (DAO).**
  * **Ответственность:** Инкапсуляция всех SQL-запросов к базе данных. Предоставляет CRUD-операции (Create, Read, Update, Delete) для всех сущностей.
  * **Реализация:** Принимает в конструкторе *функцию-поставщик* (`() => better-sqlite3.Database`), которая предоставляет активное подключение к БД по требованию. Это позволяет создавать сервисы на старте приложения, до открытия конкретного проекта.
  * **Не должен:** Содержать бизнес-логику. Только выполнение запросов.

---

## Общие ресурсы (`src/common`)

* `types.ts`: **Общие типы данных.** Содержит интерфейсы и типы (`NarrativeItem`, `WorldObject` и т.д.), которые используются в нескольких частях приложения (в `main` и `renderer` процессах, в сервисах и DAO). Это обеспечивает единый источник правды для структур данных.

---

## Структура Renderer-процесса (`src/renderer`)

* `App.tsx`: Корневой компонент React, управляющий основным состоянием UI (например, `selectedItemId`).
* `index.tsx`: Точка входа для React-приложения.
* `components/`: Директория для переиспользуемых React-компонентов.
  * `NarrativeTree.tsx` и `WorldObjectTree.tsx`: Компоненты, отвечающие за отображение иерархических данных в виде деревьев. Они также реализуют пользовательские взаимодействия (через контекстные меню) для управления элементами (создание, переименование, удаление) и подписываются на IPC-события для автоматического обновления своего состояния при изменении данных.
  * `ContentDisplay.tsx`: Компонент центральной панели, который отображает детальную информацию о выбранном элементе, включая его кастомные поля и содержимое связанного `.md`-файла. Для обеспечения синхронизации с внешними редакторами, компонент использует механизм периодического опроса (polling), проверяя дату модификации открытого файла через IPC.

### UI-компоненты и стилизация

* **Библиотека компонентов:** В качестве основной библиотеки UI-компонентов используется **Ant Design**. Это решение принято для ускорения разработки и получения консистентного, утилитарного интерфейса «из коробки».
* **Стилизация:** Глобальные стили и сбросы (`reset.css`) для Ant Design подключаются в `App.tsx`.

---

## Соглашения о файловой системе

Для связи сущностей приложения с файлами на диске используются соглашения о формировании путей.

* **Объекты мира (`world_objects`):
  * **Текущее состояние:** Для каждого объекта мира путь формируется по правилу: `<корень_проекта>/world/<имя_шаблона>/<имя_объекта>/description.md`.
  * **Проблема:** Используется `имя_объекта` (мутабельное отображаемое имя), что нарушает консистентность при переименовании.
  * **Планируемое решение:** В ближайшее время перейти на использование неизменяемого ID объекта в пути: `<корень_проекта>/world/<имя_шаблона>/<ID_объекта>/description.md`. Это гарантирует, что связь с файлом не будет нарушаться.

---

## Взаимодействие процессов и событий

Для связи между `main` и `renderer` процессами, а также между модулями внутри `main`-процесса, используется комбинация из двух подходов.

### 1. Шина событий (`eventBus`)

* **Файл:** `src/main/eventBus.ts`
* **Технология:** `EventEmitter` из Node.js.
* **Назначение:** Обеспечивает слабую связанность (decoupling) между сервисами в `main`-процессе. Например, `ProjectService` не знает о существовании `NarrativeService`, но может уведомить всю систему об открытии проекта, отправив событие в `eventBus`.
* **Примеры:**
  * `eventBus.emit('project-opened')` — отправляется `ProjectService` после успешного открытия проекта.
  * `eventBus.emit('narrative-changed')` — отправляется `NarrativeService` после изменения структуры повествования.
  * `eventBus.emit('world-objects-changed')` — отправляется `WorldObjectService` после изменения объектов мира.

### 2. Межпроцессное взаимодействие (IPC)

* **`main.ts`** прослушивает события из `eventBus` и пересылает их в `renderer`-процесс с помощью `mainWindow.webContents.send('channel')`.
* **`preload.ts`** действует как мост, безопасно предоставляя `renderer`-процессу доступ к определенным каналам `ipcRenderer`.
* **Renderer-процесс** (React-компоненты) использует `window.electron.ipcRenderer` для двух типов операций:
  * **Запрос-ответ:** `invoke('channel')` для получения данных от `main`-процесса (например, `get-narrative-items`).
  * **Подписка на события:** `on('channel', ...)` для реакции на события, инициированные `main`-процессом (например, `project-opened`).
